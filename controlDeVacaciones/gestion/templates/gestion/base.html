{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js para gr√°ficos interactivos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Inherit custom colors if needed, though we use CSS vars mostly now
                    }
                }
            }
        }
    </script>

    <!-- Nuestro CSS personalizado -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/fixes.css' %}">

    <!-- PWA Config -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="{% static 'img/icon-192.png' %}">
    
    <!-- Force Standalone Mode (iOS/Android Legacy) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>{% block title %}Control de Vacaciones - ABBAMAT{% endblock %}</title>

    {% block extra_css %}
    <style>
        /* ESTILOS DE EMERGENCIA - MAXIMA PRIORIDAD */
        #toast-container {
            position: fixed !important;
            top: 30px !important;
            right: 30px !important;
            z-index: 9999999 !important;
            width: 400px !important;
            pointer-events: none !important;
            display: block !important;
        }

        .abbamat-toast {
            pointer-events: auto !important;
            background: #ffffff !important;
            color: #1e293b !important;
            border-radius: 16px !important;
            padding: 20px !important;
            margin-bottom: 15px !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1) !important;
            border-left: 8px solid #cbd5e1 !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            gap: 15px !important;
            animation: abbamat-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important;
            position: relative !important;
        }

        .dark .abbamat-toast {
            background: #1e293b !important;
            color: #f8fafc !important;
            border-left-color: #334155 !important;
        }

        @keyframes abbamat-bounce {
            from { opacity: 0; transform: translateX(100px) scale(0.8); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }

        .abbamat-toast-success { border-left-color: #10b981 !important; }
        .abbamat-toast-error { border-left-color: #ef4444 !important; }
        .abbamat-toast-warning { border-left-color: #f59e0b !important; }
        .abbamat-toast-info { border-left-color: #3b82f6 !important; }

        .abbamat-toast-icon {
            font-size: 28px !important;
            flex-shrink: 0 !important;
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .abbamat-toast-success .abbamat-toast-icon { color: #10b981 !important; }
        .abbamat-toast-error .abbamat-toast-icon { color: #ef4444 !important; }
        .abbamat-toast-warning .abbamat-toast-icon { color: #f59e0b !important; }
        .abbamat-toast-info .abbamat-toast-icon { color: #3b82f6 !important; }

        .abbamat-toast-content {
            flex-grow: 1 !important;
            text-align: left !important;
        }

        .abbamat-toast-title {
            font-weight: 800 !important;
            font-size: 1.1rem !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            line-height: 1.2 !important;
            color: inherit !important;
        }

        .abbamat-toast-message {
            font-size: 0.95rem !important;
            margin-top: 4px !important;
            display: block !important;
            opacity: 0.85 !important;
            color: inherit !important;
        }

        .abbamat-toast-close {
            background: #f1f5f9 !important;
            color: #64748b !important;
            border: none !important;
            width: 26px !important;
            height: 26px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            font-size: 12px !important;
            flex-shrink: 0 !important;
            transition: all 0.2s !important;
        }
        .dark .abbamat-toast-close { background: #334155 !important; color: #94a3b8 !important; }
        .abbamat-toast-close:hover { background: #fee2e2 !important; color: #ef4444 !important; transform: rotate(90deg) !important; }

        .abbamat-toast-progress {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            height: 5px !important;
            background: currentColor !important;
            opacity: 0.3 !important;
            animation: abbamat-p linear forwards !important;
        }
        @keyframes abbamat-p { from { width: 100%; } to { width: 0%; } }
    </style>
    {% endblock %}
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Global Loader -->
    <div id="global-loader">
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="text-blue-600 dark:text-blue-400 font-semibold animate-pulse">Cargando...</p>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Top Navigation Bar -->
    <nav class="bg-gradient-to-r from-purple-600 via-blue-600 to-blue-700 shadow-lg sticky top-0 z-[1000]">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex items-center justify-between h-20">

                <!-- Logo and Brand -->
                <div class="flex items-center gap-8">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <i class="fas fa-umbrella-beach text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-white font-bold text-xl">ABBAMAT</h1>
                            <p class="text-blue-100 text-xs">Control de Vacaciones</p>
                        </div>
                    </div>

                    <!-- Main Navigation Links -->
                    <div class="hidden lg:flex items-center gap-2">
                        <a href="{% url 'gestion:dashboard' %}"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition {% if request.resolver_match.url_name == 'dashboard' %}bg-white/20{% endif %}">
                            <i class="fas fa-home"></i>
                            <span class="font-medium">Dashboard</span>
                        </a>

                        {% if user.empleado.es_manager %}
                        <!-- Manager Menu -->
                        <div class="relative group">
                            <button
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition">
                                <i class="fas fa-briefcase"></i>
                                <span class="font-medium">Gesti√≥n</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div
                                class="absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                                <a href="{% url 'gestion:solicitar_vacaciones' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 first:rounded-t-lg">
                                    <i class="fas fa-calendar-plus text-blue-600"></i>
                                    <span class="text-gray-700 font-medium">Nueva Solicitud</span>
                                </a>
                                <a href="{% url 'gestion:historial_global' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                    <i class="fas fa-list-check text-orange-600"></i>
                                    <span class="text-gray-700 font-medium">Solicitudes</span>
                                </a>
                                <a href="{% url 'gestion:aprobacion_manager' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                    <i class="fas fa-user-check text-green-600"></i>
                                    <span class="text-gray-700 font-medium">Aprobaciones Pendientes</span>
                                </a>

                                <a href="{% url 'gestion:calendario_global' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 last:rounded-b-lg">
                                    <i class="fas fa-calendar-days text-purple-600"></i>
                                    <span class="text-gray-700 font-medium">Calendario Global</span>
                                </a>
                            </div>
                        </div>

                        <div class="relative group">
                            <button
                                class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition">
                                <i class="fas fa-cog"></i>
                                <span class="font-medium">Administraci√≥n</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div
                                class="absolute left-0 mt-2 w-56 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                                <a href="{% url 'gestion:gestion_empleados' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 first:rounded-t-lg">
                                    <i class="fas fa-users text-green-600"></i>
                                    <span class="text-gray-700 font-medium">Empleados</span>
                                </a>
                                <a href="{% url 'gestion:gestion_saldos' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                    <i class="fas fa-wallet text-yellow-600"></i>
                                    <span class="text-gray-700 font-medium">Saldos</span>
                                </a>
                                <a href="{% url 'gestion:gestion_festivos' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                    <i class="fas fa-calendar-star text-red-600"></i>
                                    <span class="text-gray-700 font-medium">D√≠as Festivos</span>
                                </a>
                                <a href="{% url 'gestion:configurar_email' %}"
                                    class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 last:rounded-b-lg">
                                    <i class="fas fa-envelope-circle-check text-indigo-600"></i>
                                    <span class="text-gray-700 font-medium">Configurar Emails</span>
                                </a>

                            </div>
                        </div>
                        {% else %}
                        <!-- Employee Menu -->
                        <a href="{% url 'gestion:solicitar_mis_vacaciones' %}"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition">
                            <i class="fas fa-paper-plane"></i>
                            <span class="font-medium">Solicitar Vacaciones</span>
                        </a>
                        <a href="{% url 'gestion:historial_personal' %}"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition">
                            <i class="fas fa-clock-rotate-left"></i>
                            <span class="font-medium">Mi Historial</span>
                        </a>
                        <a href="{% url 'gestion:dias_disponibles' %}"
                            class="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:bg-white/20 transition">
                            <i class="fas fa-calendar-check"></i>
                            <span class="font-medium">D√≠as Disponibles</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Notificaciones -->
                <div class="relative group">
                    <a href="{% url 'gestion:lista_notificaciones' %}" class="relative p-2 text-white hover:bg-white/10 rounded-full transition-all">
                        <i class="fas fa-bell text-xl"></i>
                        <div id="notif-badge-container">
                            {% if notif_count > 0 %}
                            <span class="absolute top-0 right-0 flex h-4 w-4">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span id="notif-count-badge" class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-[10px] items-center justify-center font-bold">
                                    {{ notif_count }}
                                </span>
                            </span>
                            {% endif %}
                        </div>
                    </a>
                    
                    <!-- Dropdown r√°pido (pc) -->
                    {% if notif_list_preview %}
                    <div class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-[9999]">
                        <div class="p-4 border-bottom border-gray-50 flex justify-between items-center">
                            <span class="font-bold text-gray-800">Notificaciones</span>
                            <span id="notif-dropdown-subtitle" class="text-xs text-blue-600 font-semibold">{{ notif_count }} nuevas</span>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            {% if tareas_pendientes_count > 0 %}
                            <a href="{% url 'gestion:aprobacion_manager' %}" class="block p-4 hover:bg-amber-50 transition border-l-4 border-amber-500 bg-amber-50/30">
                                <p class="text-xs font-bold text-amber-900">‚ö†Ô∏è Tareas Pendientes de Aprobaci√≥n</p>
                                <p class="text-xs text-amber-700">Tienes {{ tareas_pendientes_count }} solicitudes esperando tu respuesta.</p>
                            </a>
                            {% endif %}

                            {% for n in notif_list_preview %}

                            <a href="{% url 'gestion:marcar_notificacion_leida' n.id %}" class="block p-4 hover:bg-gray-50 transition border-l-4 border-blue-500 bg-blue-50/30">
                                <p class="text-xs font-bold text-gray-900">{{ n.titulo }}</p>
                                <p class="text-xs text-gray-600 truncate">{{ n.mensaje }}</p>
                                <p class="text-[10px] text-gray-400 mt-1">{{ n.fecha_creacion|timesince }}</p>
                            </a>
                            {% endfor %}
                        </div>
                        <a href="{% url 'gestion:lista_notificaciones' %}" class="block p-3 text-center text-xs font-bold text-blue-600 bg-gray-50 rounded-b-xl hover:bg-blue-600 hover:text-white transition">
                            Ver todas las notificaciones
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Side - User Menu -->

                <div class="flex items-center gap-4">
                    <!-- User Info (Visible en todos los dispositivos) -->
                    <div class="flex items-center gap-2 md:gap-3 bg-white/10 px-2 py-1 rounded-full border border-white/20">
                        <div class="text-right hidden xs:block">
                            <p class="text-white font-bold text-[10px] md:text-sm leading-tight">{{ user.empleado.nombre|default:user.username }}</p>
                            <p class="text-blue-100 text-[9px] md:text-xs leading-tight">
                                {% if user.empleado.es_manager %}Manager{% else %}Empleado{% endif %}
                            </p>
                        </div>
                        <div
                            class="w-7 h-7 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white font-black shadow-lg text-[10px] md:text-base border border-white/40">
                            {{ user.empleado.nombre|first|upper }}{{ user.empleado.apellido|first|upper }}
                        </div>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <button id="theme-toggle"
                        class="p-2 rounded-lg text-white hover:bg-white/20 transition focus:outline-none"
                        title="Cambiar tema">
                        <i id="theme-toggle-dark-icon" class="fas fa-moon hidden"></i>
                        <i id="theme-toggle-light-icon" class="fas fa-sun hidden"></i>
                    </button>

                    <!-- User Dropdown -->
                    <div class="relative group">
                        <button class="p-2 rounded-lg text-white hover:bg-white/20 transition">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div
                            class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                            <a href="{% url 'gestion:mi_perfil' %}"
                                class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50 first:rounded-t-lg">
                                <i class="fas fa-user-circle text-gray-600"></i>
                                <span class="text-gray-700 font-medium">Mi Perfil</span>
                            </a>
                            {% if user.empleado.es_manager %}
                            <a href="/admin/" class="flex items-center gap-3 px-4 py-3 hover:bg-gray-50">
                                <i class="fas fa-cog text-gray-600"></i>
                                <span class="text-gray-700 font-medium">Admin Panel</span>
                            </a>
                            {% endif %}
                            <!-- Logout Form for Django 5.0+ Compliance (POST required) -->
                            <form action="{% url 'logout' %}" method="post" class="block w-full">
                                {% csrf_token %}
                                <button type="submit" class="flex w-full items-center gap-3 px-4 py-3 hover:bg-red-50 last:rounded-b-lg text-left">
                                    <i class="fas fa-right-from-bracket text-red-600"></i>
                                    <span class="text-red-700 font-medium">Cerrar Sesi√≥n</span>
                                </button>
                            </form>
                            </a>
                        </div>
                    </div>

                    <!-- PWA Install Button (Hidden by default) -->
                    <button id="install-btn" class="hidden flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition shadow-lg animate-pulse font-semibold">
                        <i class="fas fa-download"></i>
                        <span class="hidden md:inline">Instalar App</span>
                    </button>

                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-btn"
                        class="lg:hidden p-2 rounded-lg text-white hover:bg-white/20 transition">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden lg:hidden bg-blue-700 border-t border-blue-600">
            <div class="px-4 py-4 space-y-2">
                <!-- User Info Banner (Mobile) -->
                <div class="mb-4 bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-blue-400 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                            {{ user.empleado.nombre|first|upper }}{{ user.empleado.apellido|first|upper }}
                        </div>
                        <div class="flex-1">
                            <p class="text-white font-bold text-base">{{ user.empleado.nombre }} {{ user.empleado.apellido }}</p>
                            <p class="text-blue-100 text-xs">
                                {% if user.empleado.es_manager %}Manager{% else %}Empleado{% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <a href="{% url 'gestion:dashboard' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-home mr-2"></i> Dashboard
                </a>
                {% if user.empleado.es_manager %}
                <a href="{% url 'gestion:solicitar_vacaciones' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-calendar-plus mr-2"></i> Nueva Solicitud
                </a>
                <a href="{% url 'gestion:historial_global' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-list-check mr-2"></i> Solicitudes
                </a>
                <a href="{% url 'gestion:calendario_global' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-calendar-days mr-2"></i> Calendario
                </a>
                <a href="{% url 'gestion:gestion_empleados' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-users mr-2"></i> Empleados
                </a>
                <a href="{% url 'gestion:gestion_saldos' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-wallet mr-2"></i> Saldos
                </a>
                <a href="{% url 'gestion:gestion_festivos' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-calendar-star mr-2"></i> Festivos
                </a>
                {% else %}
                <a href="{% url 'gestion:solicitar_mis_vacaciones' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-paper-plane mr-2"></i> Solicitar Vacaciones
                </a>
                <a href="{% url 'gestion:historial_personal' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-clock-rotate-left mr-2"></i> Mi Historial
                </a>
                <a href="{% url 'gestion:dias_disponibles' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-calendar-check mr-2"></i> D√≠as Disponibles
                </a>
                <a href="{% url 'gestion:calendario_global' %}"
                    class="block px-4 py-3 rounded-lg text-white hover:bg-white/20 transition">
                    <i class="fas fa-calendar-days mr-2"></i> Calendario
                </a>
                {% endif %}

            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-24 right-6 z-[9999] space-y-3"></div>


    <!-- Messages/Alerts (Convertidos a Toast) -->
    {% if messages %}
    <div id="django-messages" style="display: none;">
        {% for message in messages %}
        <span class="django-message" data-type="{{ message.tags }}">{{ message }}</span>
        {% endfor %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.django-message').forEach(m => {
                const type = m.dataset.type || 'info';
                const text = m.textContent.trim();
                if (text) {
                    showToast(text, type);
                }
            });
        });
    </script>
    {% endif %}

    <!-- Page Content -->
    <main class="py-8">
        {% block content %}
        <!-- El contenido espec√≠fico de cada p√°gina va aqu√≠ -->
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6 mt-12">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm text-gray-500">
                ¬© {% now "Y" %} ABBAMAT - Sistema de Gesti√≥n de Vacaciones
            </p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // ==========================================
        // DARK MODE LOGIC
        // ==========================================
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Check local storage or system preference
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleDarkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', function() {
            // Toggle icons
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            // If is set in local storage
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                // If not set in local storage
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });

        // ==========================================
        // LOADER LOGIC
        // ==========================================
        window.addEventListener('load', function () {
            const loader = document.getElementById('global-loader');
            loader.classList.add('loader-hidden');
            setTimeout(() => {
                loader.style.display = 'none';
            }, 300); // Wait for transition
        });

        // Show loader on navigation (optional, but gives a smoother feel)
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function (e) {
                const target = this.getAttribute('href');
                // Only show if it's a valid internal link and not a hash/anchor
                if (target && target.startsWith('/') && !target.startsWith('#')) {
                    const loader = document.getElementById('global-loader');
                    loader.style.display = 'flex';
                    // Small delay to allow display:flex to apply before removing opacity class
                    requestAnimationFrame(() => {
                        loader.classList.remove('loader-hidden');
                    });
                }
            });
        });


        // Toggle mobile menu
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

// ==========================================
        // TOAST NOTIFICATIONS SYSTEM
        // ==========================================
        function showToast(message, type = 'info', title = null, duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `abbamat-toast abbamat-toast-${type}`;
            
            // Iconos seg√∫n el tipo
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            // T√≠tulos seg√∫n el tipo si no se provee uno
            const defaultTitles = {
                success: '¬°Logrado!',
                error: 'Hubo un problema',
                warning: 'Atenci√≥n',
                info: 'Aviso del sistema'
            };

            const displayTitle = title || defaultTitles[type] || 'Notificaci√≥n';

            toast.innerHTML = `
                <div class="abbamat-toast-icon">
                    <i class="fas ${icons[type] || icons.info}"></i>
                </div>
                <div class="abbamat-toast-content">
                    <div class="abbamat-toast-title">${displayTitle}</div>
                    <div class="abbamat-toast-message">${message}</div>
                </div>
                <button class="abbamat-toast-close" onclick="removeToast(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
                <div class="abbamat-toast-progress" style="animation-duration: ${duration}ms"></div>
            `;

            container.appendChild(toast);

            // Auto-eliminar despu√©s del duration
            setTimeout(() => {
                removeToast(toast);
            }, duration);
        }

        function removeToast(toast) {
            if (!toast || toast.classList.contains('removing')) return;
            
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // ==========================================
        // SKELETON LOADER UTILITIES
        // ==========================================
        function showSkeleton(container, count = 1, type = 'card') {
            if (!container) return;
            
            const skeletons = [];
            for (let i = 0; i < count; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = `skeleton skeleton-${type}`;
                container.appendChild(skeleton);
                skeletons.push(skeleton);
            }
            
            return skeletons;
        }

        function hideSkeleton(container, content) {
            if (!container) return;
            
            // Eliminar skeletons
            const skeletons = container.querySelectorAll('.skeleton');
            skeletons.forEach(skeleton => skeleton.remove());
            
            // Agregar contenido con animaci√≥n
            if (content) {
                content.style.opacity = '0';
                container.appendChild(content);
                setTimeout(() => {
                    content.style.opacity = '1';
                    content.style.transition = 'opacity 0.3s ease';
                }, 50);
            }
        }

        // ==========================================
        // LOADING STATES PARA FORMULARIOS Y BOTONES
        // ==========================================
        function setButtonLoading(button, loading = true) {
            if (!button) return;
            
            if (loading) {
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.dataset.originalContent = originalContent;
                button.innerHTML = `
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    ${button.textContent.trim()}
                `;
                button.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalContent || button.innerHTML;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
                delete button.dataset.originalContent;
            }
        }

        function setFormLoading(form, loading = true) {
            if (!form) return;
            
            const buttons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
            buttons.forEach(button => setButtonLoading(button, loading));
            
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (loading) {
                    input.disabled = true;
                    input.classList.add('opacity-50');
                } else {
                    input.disabled = false;
                    input.classList.remove('opacity-50');
                }
            });
        }

        // ==========================================
        // AUTO-CERRAR ALERTAS ANTIGUAS (MIGRACI√ìN)
        // ==========================================
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>

    {% block extra_js %}{% endblock %}

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Registramos el SW desde la ra√≠z para tener scope global
                navigator.serviceWorker.register("/sw.js")
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <!-- PWA Install Logic & Debugging -->
    <script>
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        // 1. Ocultar bot√≥n inicialmente y si ya est√° instalado
        if (installBtn) {
            if (window.matchMedia('(display-mode: standalone)').matches) {
                installBtn.style.display = 'none';
            } else {
                installBtn.classList.add('hidden');
            }
        }

        // 2. Escuchar evento de instalaci√≥n
        window.addEventListener('beforeinstallprompt', (e) => {
            // Si ya estamos en modo standalone, no mostramos nada
            if (window.matchMedia('(display-mode: standalone)').matches) {
                return;
            }

            console.log('üëç PWA Install Prompt fired!');
            e.preventDefault();
            deferredPrompt = e;
            
            // Habilitar bot√≥n solo si no est√° instalado
            if (installBtn) {
                installBtn.classList.remove('hidden');
                installBtn.classList.add('flex', 'bg-emerald-500', 'hover:bg-emerald-600');
                installBtn.querySelector('span').textContent = 'üì≤ Instalar App';
            }
        });

        // 3. L√≥gica del bot√≥n con Instrucciones de Ayuda
        if (installBtn) {
            // Solo mostramos ayuda si pasan 5 segundos y sabemos que es un Android/iOS que SOPORTA PWA pero no dispar√≥ el evento
            setTimeout(() => {
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (isMobile && !deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                    console.log("Showing manual install helper");
                    // No mostramos el bot√≥n gigante, sino un toast informativo opcional
                }
            }, 5000);

            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                     // Instrucciones manuales para cuando falta HTTPS
                     alert("‚ö†Ô∏è Android requiere HTTPS para la instalaci√≥n autom√°tica.\n\nPara instalar manualmente:\n1. Toca los 3 puntos del navegador (arriba a la derecha).\n2. Busca la opci√≥n 'Agregar a la pantalla principal' o 'Instalar aplicaci√≥n'.");
                     return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User choice: ${outcome}`);
                deferredPrompt = null;
            });
        }

        // 4. Confirmaci√≥n de instalaci√≥n
        window.addEventListener('appinstalled', () => {
            showToast('¬°Aplicaci√≥n instalada con √©xito!', 'success');
            if (installBtn) installBtn.style.display = 'none';
        });

        // 5. Debug de Service Worker y Contexto Seguro
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then((registration) => {
                console.log('SW Ready:', registration);
            });
        } else {
             // Diagn√≥stico preciso
             if (!window.isSecureContext) {
                 showToast('PWA Desactivado: Falta conexi√≥n segura (HTTPS)', 'error');
                 console.warn("‚ö†Ô∏è PWA requiere HTTPS o Localhost. Chrome deshabilita Service Workers en redes inseguras (192.168...). Configura chrome://flags o usa Ngrok.");
                 
                 // Actualizar bot√≥n para reflejar esto
                 if(installBtn) {
                     installBtn.querySelector('span').textContent = 'Error: Sitio No Seguro';
                     installBtn.classList.remove('opacity-50', 'bg-blue-400', 'bg-emerald-500');
                     installBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'cursor-help');
                     
                     installBtn.onclick = () => alert("‚õî ERROR DE SEGURIDAD\n\nAndroid bloquea las funciones de App porque est√°s usando 'http' (inseguro) en lugar de 'https' (candado).\n\nSOLUCI√ìN:\n1. Usa 'chrome://flags' en el celular para permitir esta IP.\n2. O usa un t√∫nel seguro como Ngrok.");
                 }
             } else {
                 showToast('Tu navegador es muy antiguo para PWA', 'error');
             }
        }

        // ==========================================
        // REAL-TIME NOTIFICATIONS POLLING
        // ==========================================
        let lastNotifId = parseInt("{{ notif_last_id|default:0 }}");
        const POLL_INTERVAL = 5000; // 5 segundos para una respuesta m√°s r√°pida

        function checkNotificaciones() {
            fetch(`/gestion/api/check_notificaciones/?last_id=${lastNotifId}`)
            .then(response => response.json())
            .then(data => {
                // 1. Actualizar el distintivo (badge) de la campana
                const badgeContainer = document.getElementById('notif-badge-container');
                if (badgeContainer) {
                    if (data.unread_count > 0) {
                        badgeContainer.innerHTML = `
                            <span class="absolute top-0 right-0 flex h-4 w-4">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span id="notif-count-badge" class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-[10px] items-center justify-center font-bold">
                                    ${data.unread_count}
                                </span>
                            </span>
                        `;
                    } else {
                        badgeContainer.innerHTML = '';
                    }
                }

                // 2. Actualizar texto del dropdown
                const dropdownSub = document.getElementById('notif-dropdown-subtitle');
                if (dropdownSub) {
                    dropdownSub.textContent = `${data.unread_count} nuevas`;
                }

                // 3. Si hay notificaciones nuevas en este poll, mostrar Toasts
                if (data.nuevas && data.nuevas.length > 0) {
                    data.nuevas.forEach(n => {
                        showToast(n.mensaje, 'info', n.titulo);
                        
                        // Sonido sutil de notificaci√≥n (opcional, habilitado por defecto)
                        try {
                            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                            audio.volume = 0.3;
                            audio.play();
                        } catch(e) { /* Bloqueado por el navegador hasta interacci√≥n */ }
                    });
                    lastNotifId = data.last_id;
                }

                // 4. Actualizar contadores del DASHBOARD si est√°n presentes
                // Buscar contadores de "Solicitudes Pendientes" (para managers)
                const pendingCounters = document.querySelectorAll('.counter[data-target]');
                pendingCounters.forEach(counter => {
                    // Si el elemento parece ser el de solicitudes pendientes
                    const parentCard = counter.closest('.kpi-card');
                    if (parentCard && (parentCard.innerHTML.includes('Solicitudes Pendientes') || parentCard.innerHTML.includes('revisi√≥n r√°pida'))) {
                        const targetVal = parseInt(counter.getAttribute('data-target'));
                        if (targetVal !== data.tareas_pendientes) {
                            counter.innerText = data.tareas_pendientes;
                            counter.setAttribute('data-target', data.tareas_pendientes);
                            // Peque√±o efecto visual de actualizaci√≥n
                            counter.classList.add('text-blue-600', 'scale-110');
                            setTimeout(() => counter.classList.remove('text-blue-600', 'scale-110'), 2000);
                        }
                    }
                });
            })
            .catch(err => console.debug("Polling silent error:", err));
        }

        // Iniciar el ciclo de vida de tiempo real
        if (document.getElementById('notif-badge-container')) {
            // Esperar un poco antes del primer check
            setTimeout(checkNotificaciones, 2000);
            setInterval(checkNotificaciones, POLL_INTERVAL);
        }

    </script>
</body>

</html>